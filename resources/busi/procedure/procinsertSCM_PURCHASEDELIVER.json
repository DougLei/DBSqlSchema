{
	"id":"id1",
	"type":"procedure",
	"description":"",
	"content":{
		"procedureName":"procinsertSCM_PURCHASEDELIVER",
		"isCover":true,
		"isTransaction":true,
		"parameters":[
			{
				"name":"Ids",
				"dataType":"varchar",
				"length":2500
			},
			{
				"name":"purchasedeptid",
				"dataType":"varchar",
				"length":50
			},
			{
				"name":"purchasemanid",
				"dataType":"varchar",
				"length":50
			},
			{
				"name":"Message",
				"dataType":"varchar",
				"inOut":"out"
			}
		],
		"declares":[
			{
				"name":"tempTable",
				"dataType":"tmp_table",
				"custom":{
					"typeName":"mytmptable",
					"isCreateType":true,			
					"column":[
						{
							"name":"ID",
							"dataType":"varchar",
							"length":50
						},
						{
							"name":"R",
							"dataType":"integer",
							"length":50
						}
					]
				}
			},
			{
				"name":"DELIVERCODE",
				"dataType":"varchar",
				"length":50
			},
			{
				"name":"PURCHASEID",
				"dataType":"varchar",
				"length":50
			},
			{
				"name":"R",
				"dataType":"integer"
			},
			{
				"name":"NUM",
				"dataType":"integer"
			}
		],

		"step1":{
			"id":"step1",
			"type":"sql",
			"content":[
				{
					"sqlJson":{
						"type": "insert",
						"content": {
							"paramName":"tempTable",
							"column": [
								"ID","R"
							],
							"values": {
								"type": "sub_query",
								"sqlJson":{
									"type":"select",
									"content":{
										"resultSet":[
											{
												"columnName":"T.value"
											},
											{
												"function":{
													"name":"_row_number_over",
													"orderBy":[
														{
															"columnName":"T.value",
															"sort":"asc"
														}
													]
												},
												"alias":"R"
											}
										],
										"table":{
											"type":"function",
											"alias":"T",
											"function":{
												"name":"F_Split",
												"parameters":[
													{
														"type":"parameter",
														"paramName":"Ids"
													},
													{
														"type":"value",
														"value":"','"
													}
												]
											}
										},
										"join":[
											{
												"type":"left",
												"tableType":"table",
												"tableName":"SCM_PURCHASE",
												"alias":"R",
												"on":[
													{
														"onGroup":[
															{
																"leftColumnName":"T.value",
																"operator":"eq",
																"rightColumnName":"R.ID"
															}
														]
													}
												]
											}
										]
									}
								}
							}
						}
					}
				}
			]
		},
		"step2":{
			"type":"if_else",
			"if1":{
				"isExistsCondition":{
					"sqlJson":{
						"type":"select",
						"content":{
							"resultSet":[
								{
									"columnName":"ID"
								}
							],
							"table":{
								"type":"table",
								"name":"SCM_PURCHASE"
							},
							"where":[
								{
									"whereGroup":[
										{
											"columnName":"RECORDSTATUS",
											"operator":"eq",
											"value":{
												"type":"value",
												"values":[
													{
														"type":"value",
														"value":"9"
													}
												]
											},
											"nextLogicOperator":"and"
										},
										{
											"columnName":"ID",
											"operator":"in",
											"value":{
												"type":"sub_query",
												"sqlJson":{
													"id":"selectIdFromTemplate",
													"type":"select",
													"content":{
														"resultSet":[
															{
																"columnName":"ID"
															}
														],
														"table":{
															"type":"parameter",
															"paramName":"tempTable"
														}
													}
												}
											}
										}
									]
								}
							]
						}
					}
				},
				"content":[
					{
						"stepJson":{
							"type":"set_value",
							"content":[
								{
									"parameters":[
										{
											"isDeclare":false,
											"name":"Message"
										}
									],
									"type":"value",
									"value":"'warning:选中行的领出记录下，存在记录状态为【起草】记录，请重新选择。'"
								}
							]
						}
					}
				]
			},
			"if2":{
				"isExistsCondition":{
					"isInversion":true,
					"sqlJson":{
						"type":"select",
						"content":{
							"resultSet":[
								{
									"columnName":"1"
								}
							],
							"table":{
								"type":"table",
								"name":"SCM_PURCHASEDETAILS"
							},
							"where":[
								{
									"whereGroup":[
										{
											"columnName":"PURCHASEID",
											"operator":"in",
											"value":{
												"type":"sub_query",
												"sqlId":"selectIdFromTemplate"
											}
										}
									]
								}
							]
						}
					}
				},
				"content":[
					{
						"stepJson":{
							"type":"set_value",
							"content":[
								{
									"parameters":[
										{
											"isDeclare":false,
											"name":"Message"
										}
									],
									"type":"value",
									"value":"'warning:子表无数据，不能确认！'"
								}
							]
						}
					},
					{
						"stepJson":{
							"type":"return"
						}
					}
				]
			},		
			"if3":{
				"isExistsCondition":{
					"type":"sql",
					"sqlJson":{
						"type":"select",
						"content":{
							"resultSet":[
								{
									"columnName":"1"
								}
							],
							"table":{
								"type":"table",
								"name":"SCM_PURCHASEDETAILS"
							},
							"where":[
								{
									"whereGroup":[
										{
											"columnName":"PURCHASEID",
											"operator":"in",
											"value":{
												"type":"sub_query",
												"sqlId":"selectIdFromTemplate"
											}
										}
									]
								}
							],
							"groupBy":[
								{
									"columnName":"MATERIALID"
								},
								{
									"columnName":"PURCHASEID"
								}
							],
							"having":[
								{
									"havingGroup":[
										{
											"columnFunction":{
												"name":"count",
												"parameters":[
													{
														"type":"value",
														"value":"MATERIALID"
													}
												]
											},
											"operator":"gt",
											"value":{
												"type":"value",
												"values":[
													{
														"type":"value",
														"value":"1"
													}
												]
											}
										}
									]
								}
							]
						}
					}
				},
				"content":[
					{
						"stepJson":{
							"type":"set_value",
							"content":[
								{
									"parameters":[
										{
											"isDeclare":false,
											"name":"Message"
										}
									],
									"type":"value",
									"value":"'warning:子表有重复数据，不能确认！'"
								}
							]
						}
					},
					{
						"stepJson":{
							"type":"return"
						}
					}
				]
			},
			"if4":{
				"content":[
					{
						"stepJson":{
							"type":"set_value",
							"content":[
								{
									"parameters":[
										{
											"isDeclare":false,
											"name":"R"
										}
									],
									"type":"value",
									"value":"1"
								},
								{
									"parameters":[
										{
											"isDeclare":false,
											"name":"NUM"
										}
									],
									"type":"value",
									"value":"0"
								},
								{
									"parameters":[
										{
											"isDeclare":false,
											"name":"NUM"
										}
									],
									"type":"select_sql",
									"sqlJson":{
										"type":"select",
										"content":{
											"isDistinct":false,
											"resultSet":[
												{
													"function":{
														"name":"count",
														"parameters":[
															{
																"type":"value",
																"value":"*"
															}
														]
													}
												}
											],
											"table":{
												"type":"parameter",
												"paramName":"tempTable"
											}
										}
									}
								}
							]
						}
					},
					{
						"stepJson":{
							"type":"while",
							"condition":[
								{
									"conditionGroup":[
										{
											"leftType":"parameter",
											"leftName":"R",
											"operator":"le",
											"rightType":"parameter",
											"rightName":"NUM"
										}
									]
								}
							],
							"content":[
								{
									"stepJson":{
										"type":"set_value",
										"content":[
											{
												"parameters":[
													{
														"isDeclare":false,
														"name":"PURCHASEID"
													}
												],
												"type":"function",
												"function":{
													"name":"_guid"
												}
											},
											{
												"parameters":[
													{
														"isDeclare":true,
														"name":"EightYear",
														"dataType":"varchar",
														"length":8
													}
												],
												"type":"function",
												"function":{
													"name":"_datetochar",
													"sourceParameter":{
														"type":"function",
														"function":{
															"name": "_current_date"
														}
													},
													"dateStyleCode": 6
												}
											},
											{
												"parameters":[
													{
														"isDeclare":true,
														"name":"ShunXuHao",
														"dataType":"varchar",
														"length":10
													}
												],
												"type":"select_sql",
												"sqlJson":{
													"type":"select",
													"content":{
														"resultSet":[
															{
																"function":{
																	"name":"max",
																	"parameters":[
																		{
																			"type":"function",
																			"function":{
																				"name":"_substring",
																				"parameter":{
																					"type":"value",
																					"value":"DELIVERCODE"
																				},
																				"subIndex":-3
																			}
																		}
																	]
																}
															}
														],
														"table":{
															"type":"table",
															"name":"SCM_PURCHASEDELIVER"
														},
														"where":[
															{
																"whereGroup":[
																	{
																		"columnFunction":{
																			"name":"_substring",
																			"parameter":{
																				"type":"function",
																				"function":{
																					"name":"_isnull",
																					"parameter":{
																						"type":"value",
																						"value":"DELIVERCODE"
																					},
																					"defaultParameter":{
																						"type":"value",
																						"value":"''"
																					}
																				}
																			},
																			"subIndex":5,
																			"subLength":8
																		},
																		"operator":"eq",
																		"value":{
																			"type":"value",
																			"values":[
																				{
																					"type":"parameter",
																					"paramName":"EightYear"
																				}
																			]
																		}
																	}
																]
															}
														]
													}
												}
											}
										]
									}
								},
								{
									"stepJson":{
										"type":"if_else",
										"if1":{
											"condition":[
												{
													"conditionGroup":[
														{
															"leftType":"parameter",
															"leftName":"ShunXuHao",
															"operator":"eq",
															"rightType":"null_value"
														}
													]
												}
											],
											"content":[
												{
													"stepJson":{
														"type":"set_value",
														"content":[
															{
																"parameters":[
																	{
																		"isDeclare":false,
																		"name":"ShunXuHao"
																	}
																],
																"type":"value",
																"value":"'001'"
															}
														]
													}
												}
											]
										},
										"if2":{
											"content":[
												{
													"stepJson":{
														"type":"set_value",
														"content":[
															{
																"parameters":[
																	{
																		"isDeclare":false,
																		"name":"ShunXuHao"
																	}
																],
																"type":"function",
																"function":{
																	"name":"_append",
																	"parameters":[
																		{
																			"type":"parameter",
																			"paramName":"ShunXuHao"
																		},
																		{
																			"type":"value",
																			"value":"1"
																		},
																		{
																			"type":"value",
																			"value":"''"
																		}
																	]
																}
															}
														]
													}
												},
												{
													"stepJson":{
														"type":"while",
														"condition":[
															{
																"conditionGroup":[
																	{
																		"leftType":"function",
																		"leftFunction":{
																			"name":"_length",
																			"parameter":{
																				"type":"parameter",
																				"paramName":"ShunXuHao"
																			}
																		},
																		"operator":"lt",
																		"rightType":"value",
																		"rightValue":"3"
																	}
																]
															}
														],
														"content":[
															{
																"stepJson":{
																	"type":"set_value",
																	"content":[
																		{
																			"parameters":[
																				{
																					"isDeclare":false,
																					"name":"ShunXuHao"
																				}
																			],
																			"type":"function",
																			"function":{
																				"name":"_append",
																				"parameters":[
																					{
																						"type":"value",
																						"value":"'0'"
																					},
																					{
																						"type":"parameter",
																						"paramName":"ShunXuHao"
																					}
																				]
																			}
																		}
																	]
																}
															}
														]
													}
												}
											]
										}	
									}
								},
								{
									"stepJson":{
										"type":"set_value",
										"content":[
											{
												"parameters":[
													{
														"isDeclare":false,
														"name":"DELIVERCODE"
													}
												],
												"type":"function",
												"function":{
													"name":"_append",
													"parameters":[
														{
															"type":"value",
															"value":"'CGDH'"
														},
														{
															"type":"parameter",
															"paramName":"EightYear"
														},
														{
															"type":"parameter",
															"paramName":"ShunXuHao"
														}
													]
												}
											}
										]
									}
								},
								{
									"stepJson":{
										"type":"sql",
										"content":[
											{
												"sqlJson":{
													"type": "insert",
													"content": {
														"name":"SCM_PURCHASEDELIVER",
														"column": [
															"DELIVERCODE",
															"DATAFROM",
															"REFCODE",
															"SUPPLIERID",
															"PURCHASEDEPTID",
															"DELIVERTIME",
															"PURCHASEMANID",
															"SORTCODE",
															"REMARK",
															"DELETEFLAG",
															"RECORDSTATUS",
															"ID",
															"CUSTOMER_ID",
															"PROJECT_ID",
															"CREATE_DATE",
															"LAST_UPDATE_DATE",
															"CREATE_USER_ID",
															"LAST_UPDATE_USER_ID"
														],
														"values": {
															"type": "sub_query",
															"sqlJson":{
																"type":"select",
																"content":{
																	"resultSet":[
																		{
																			"paramName":"DELIVERCODE"
																		},
																		{
																			"columnName":"7"
																		},
																		{
																			"columnName":"PURCHASECODE"
																		},
																		{
																			"columnName":"SUPPLIERID"
																		},
																		{
																			"paramName":"purchasedeptid"
																		},
																		{
																			"function":{
																				"name":"_current_date"
																			}
																		},
																		{
																			"paramName":"purchasemanid"
																		},
																		{
																			"columnName":"''"
																		},
																		{
																			"columnName":"''"
																		},
																		{
																			"columnName":"1"
																		},
																		{
																			"columnName":"1"
																		},
																		{
																			"paramName":"PURCHASEID"
																		},
																		{
																			"columnName":"CUSTOMER_ID"
																		},
																		{
																			"columnName":"PROJECT_ID"
																		},
																		{
																			"function":{
																				"name":"_current_date"
																			}
																		},
																		{
																			"function":{
																				"name":"_current_date"
																			}
																		},
																		{
																			"paramName":"purchasemanid"
																		},
																		{
																			"paramName":"purchasemanid"
																		}
																	],
																	"table":{
																		"type":"table",
																		"name":"SCM_PURCHASE"
																	},
																	"where":[
																		{
																			"whereGroup":[
																				{
																					"columnName":"ID",
																					"operator":"in",
																					"value":{
																						"type":"sub_query",
																						"sqlJson":{
																							"id":"setSubQuery",
																							"type":"select",
																							"content":{
																								"resultSet":[
																									{
																										"columnName":"t.ID"
																									}
																								],
																								"table":{
																									"type":"parameter",
																									"paramName":"tempTable"
																								},
																								"where":[
																									{
																										"whereGroup":[
																											{
																												"columnName":"R",
																												"operator":"eq",
																												"value":{
																													"type":"value",
																													"values":[
																														{
																															"type":"parameter",
																															"paramName":"R"
																														}
																													]
																												}
																											}
																										]
																									}
																								]
																							}
																						}
																					}
																				}
																			]
																		}
																	]
																}
															}
														}
													}
												}
											},
											{
												"sqlJson":{
													"type": "insert",
													"content": {
														"name":"SCM_PURCHASEDELIVERDETAILS",
														"column": [
															"DELIVERID",
															"MATERIALID",
															"DELIVERNUMBER",
															"ID",
															"CUSTOMER_ID",
															"PROJECT_ID",
															"CREATE_DATE",
															"LAST_UPDATE_DATE",
															"CREATE_USER_ID",
															"LAST_UPDATE_USER_ID"
														],
														"values": {
															"type": "sub_query",
															"sqlJson":{
																"type":"select",
																"content":{
																	"resultSet":[
																		{
																			"paramName":"PURCHASEID"
																		},
																		{
																			"columnName":"S.MATERIALID"
																		},
																		{
																			"columnName":"S.PURCHASENUMBER"
																		},
																		{
																			"function":{
																				"name":"_guid"
																			}
																		},
																		{
																			"columnName":"S.CUSTOMER_ID"
																		},
																		{
																			"columnName":"S.PROJECT_ID"
																		},
																		{
																			"function":{
																				"name":"_current_date"
																			}
																		},
																		{
																			"function":{
																				"name":"_current_date"
																			}
																		},
																		{
																			"paramName":"purchasemanid"
																		},
																		{
																			"paramName":"purchasemanid"
																		}
																	],
																	"table":{
																		"type":"table",
																		"name":"SCM_PURCHASEDETAILS",
																		"alias":"S"
																	},
																	"join":[
																		{
																			"type":"left",
																			"tableType":"table",
																			"tableName":"SCM_PURCHASE",
																			"alias":"R",
																			"on":[
																				{
																					"onGroup":[
																						{
																							"leftColumnName":"S.PURCHASEID",
																							"operator":"eq",
																							"rightColumnName":"R.ID"
																						}
																					]
																				}
																			]
																		}
																	],
																	"where":[
																		{
																			"whereGroup":[
																				{
																					"columnName":"s.PURCHASEID",
																					"operator":"in",
																					"value":{
																						"type":"sub_query",
																						"sqlId":"setSubQuery"
																					}
																				}
																			]
																		}
																	]
																}
															}
														}
													}
												}
											}
										]
									}
								},
								{
									"stepJson":{
										"type":"set_value",
										"content":[
											{
												"parameters":[
													{
														"isDeclare":false,
														"name":"R"
													}
												],
												"type":"function",
												"function":{
													"name":"_append",
													"parameters":[
														{
															"type":"parameter",
															"paramName":"R"
														},
														{
															"type":"value",
															"value":"1"
														}
													]
												}
											}
										]
									}
								}
							]
						}
					},
					{
						"stepJson":{
							"type":"set_value",
							"content":[
								{
									"parameters":[
										{
											"isDeclare":false,
											"name":"Message"
										}
									],
									"type":"value",
									"value":"'success:操作完成'"
								}
							]
						}
					}
				]
			}
		}
	}
}