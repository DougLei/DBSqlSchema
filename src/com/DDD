DECLARE 

@RESOURCESBARCODE VARCHAR(1000),
@RESOURCESBARCODE1 VARCHAR(1000),
@CHECKPOSITIONDETAILSID VARCHAR(50)


SELECT @CHECKPOSITIONDETAILSID = A.CHECKPOSITIONDETAILSID FROM        /*获取该检测项目下的明细ID*/
    (
    SELECT 
    F.CHECKPOSITIONDETAILSID AS CHECKPOSITIONDETAILSID
    FROM MES_CHECKPOSITIONDATA F
    LEFT JOIN MES_CHECKDATA A
    ON F.CHECKELEMENTID = A.ID
    LEFT JOIN MES_PROCESSDETAILS B
    ON A.PROCESSDETAILSID = B.ID
    LEFT JOIN MES_WORKORDERSINGLECODE C
    ON B.WORKORDERSINGLECODEID = C.ID
    WHERE B.WORKORDERID = '320D613B-2CE4-491E-9394-B14062EF67BD'   AND B.ID = 'D63F91FA-0561-432C-AE02-925D04C627DF'  AND A.PFCHECKELEMENTID = 'C60A6E4C-C7CF-4543-A058-78D56517E61A'
    AND c.ID = (select  top 1 value from F_Split('7AB5348C-A6D0-43BC-829C-C16D514C6301',',') ) 
    UNION all
    SELECT 
    F.WEIGHDETAILSID AS CHECKPOSITIONDETAILSID
    FROM MES_WEIGHDATA F
    JOIN MES_CHECKDATA A
    ON F.CHECKELEMENTID = A.ID
    LEFT JOIN MES_PROCESSDETAILS B
    ON A.PROCESSDETAILSID = B.ID
    LEFT JOIN MDM_MATERIALINFO C
    ON F.MATERIALID = C.ID
    LEFT JOIN MES_WORKORDERSINGLECODE D
    ON B.WORKORDERSINGLECODEID = D.ID
    WHERE B.WORKORDERID = '320D613B-2CE4-491E-9394-B14062EF67BD'  AND B.ID = 'D63F91FA-0561-432C-AE02-925D04C627DF'  AND A.PFCHECKELEMENTID = 'C60A6E4C-C7CF-4543-A058-78D56517E61A'
    AND D.ID = (select  top 1 value from F_Split('7AB5348C-A6D0-43BC-829C-C16D514C6301',',') ) 
    UNION all 
    SELECT 
    F.CHECKLISTDETAILSID AS CHECKPOSITIONDETAILSID
    FROM MES_CHECKLISTDATA F
    LEFT JOIN MES_CHECKDATA A
    ON F.CHECKELEMENTID = A.ID
    LEFT JOIN MES_PROCESSDETAILS B
    ON A.PROCESSDETAILSID = B.ID
    LEFT JOIN MES_WORKORDERSINGLECODE C
    ON B.WORKORDERSINGLECODEID = C.ID
    WHERE B.WORKORDERID = '320D613B-2CE4-491E-9394-B14062EF67BD'  and B.ID = 'D63F91FA-0561-432C-AE02-925D04C627DF'  AND A.PFCHECKELEMENTID = 'C60A6E4C-C7CF-4543-A058-78D56517E61A'
    AND c.ID = (select  top 1 value from F_Split('7AB5348C-A6D0-43BC-829C-C16D514C6301',',') ) 
   )AS A




SELECT @RESOURCESBARCODE = B.MEASUREBARCODE FROM
(
SELECT  MAX(MEASUREBARCODE) AS MEASUREBARCODE  FROM MES_CHECKPOSITIONDATA WHERE ID IN
 (SELECT  ID FROM MES_CHECKPOSITIONDATA WHERE CHECKPOSITIONDETAILSID = '9a8174aa32c64c368a4a79bcfc5e13af' AND CHECKELEMENTID IN
 (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
 (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
 ('7AB5348C-A6D0-43BC-829C-C16D514C6301',',')
 )
 )
 ) 
 )
 )
 UNION ALL
 SELECT  MAX(MEASUREBARCODE) AS MEASUREBARCODE  FROM MES_CHECKLISTDATA WHERE ID =
 (SELECT  ID FROM MES_CHECKLISTDATA WHERE CHECKLISTDETAILSID = '9a8174aa32c64c368a4a79bcfc5e13af' AND CHECKELEMENTID IN
 (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
 (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
 ('7AB5348C-A6D0-43BC-829C-C16D514C6301',',')
 )
 )
 ) 
 )
 )
 UNION ALL
 SELECT  MAX(EQUIPMENTBARCODE) AS MEASUREBARCODE  FROM MES_WEIGHDATA WHERE ID IN
 (SELECT  ID FROM MES_WEIGHDATA WHERE WEIGHDETAILSID = '9a8174aa32c64c368a4a79bcfc5e13af' AND CHECKELEMENTID IN
 (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
 (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
 ('7AB5348C-A6D0-43BC-829C-C16D514C6301',',')
 )
 )
 ) 
 )
 )
 ) AS B

 
DECLARE @tempTable TABLE
(
  ID varchar(2500)
)
DECLARE 
@value VARCHAR(50)
INSERT INTO @tempTable
SELECT
  value
FROM
  [dbo].F_Split('3775c6d24acc4666a87628f272252da5,638bff414f23459fbb09b33d556a470d',',')


SET @value = '3775c6d24acc4666a87628f272252da5'

DELETE FROM @tempTable WHERE 
ID = @value

select  *  from  @tempTable

SELECT @RESOURCESBARCODE1 =  STUFF((SELECT ',' +ID FROM  @tempTable FOR XML PATH('')),1,1,'')
select  @RESOURCESBARCODE1


 IF(SELECT DISTINCT ELEMENTFLAG FROM MES_CHECKDATA WHERE PFCHECKELEMENTID = 'C60A6E4C-C7CF-4543-A058-78D56517E61A') = 1
	 BEGIN
      UPDATE MES_CHECKPOSITIONDATA
      SET MEASUREBARCODE = @RESOURCESBARCODE1
      WHERE ID IN (SELECT  ID FROM MES_CHECKPOSITIONDATA WHERE CHECKPOSITIONDETAILSID = '9a8174aa32c64c368a4a79bcfc5e13af' AND CHECKELEMENTID IN
      (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
      (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
      ('7AB5348C-A6D0-43BC-829C-C16D514C6301',',')
      )
      )
      ) 
      )
     )
	 END
	 ELSE IF(SELECT DISTINCT ELEMENTFLAG FROM MES_CHECKDATA WHERE PFCHECKELEMENTID = 'C60A6E4C-C7CF-4543-A058-78D56517E61A') = 2
	 BEGIN
	 UPDATE MES_WEIGHDATA
      SET EQUIPMENTBARCODE = @RESOURCESBARCODE1
      WHERE ID IN (SELECT  ID FROM MES_WEIGHDATA WHERE WEIGHDETAILSID = '9a8174aa32c64c368a4a79bcfc5e13af' AND CHECKELEMENTID IN
      (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
      (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
      ('7AB5348C-A6D0-43BC-829C-C16D514C6301',',')
      )
      )
      ) 
      )
     )
	 END
	 ELSE IF(SELECT DISTINCT ELEMENTFLAG FROM MES_CHECKDATA WHERE PFCHECKELEMENTID = 'C60A6E4C-C7CF-4543-A058-78D56517E61A') = 3
	 BEGIN
	 UPDATE MES_CHECKLISTDATA
      SET MEASUREBARCODE = @RESOURCESBARCODE1
	  
      WHERE ID = (SELECT  ID FROM MES_CHECKLISTDATA WHERE CHECKLISTDETAILSID = '9a8174aa32c64c368a4a79bcfc5e13af' AND CHECKELEMENTID IN
      (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
      (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
      ('7AB5348C-A6D0-43BC-829C-C16D514C6301',',')
      )
      )
      ) 
      )
      )
	  print 'aaa'+@RESOURCESBARCODE1
	  END
	 print 'BBB'+@RESOURCESBARCODE1

	 select *  from MES_CHECKLISTDATA where id= '517EEB50-CC4A-4938-8DCD-5F9E8A47BC9F'