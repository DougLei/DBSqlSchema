DECLARE 
@value VARCHAR(50),
@RESOURCESBARCODE VARCHAR(1000),
@RESOURCESBARCODE1 VARCHAR(1000),
@CHECKPOSITIONDETAILSID VARCHAR(50)


SELECT @CHECKPOSITIONDETAILSID = A.CHECKPOSITIONDETAILSID FROM        /*获取该检测项目下的明细ID*/
    (
    SELECT 
    F.CHECKPOSITIONDETAILSID AS CHECKPOSITIONDETAILSID
    FROM MES_CHECKPOSITIONDATA F
    LEFT JOIN MES_CHECKDATA A
    ON F.CHECKELEMENTID = A.ID
    LEFT JOIN MES_PROCESSDETAILS B
    ON A.PROCESSDETAILSID = B.ID
    LEFT JOIN MES_WORKORDERSINGLECODE C
    ON B.WORKORDERSINGLECODEID = C.ID
    WHERE B.WORKORDERID = $workorderid$   AND B.ID = $processdetailsid$  AND A.PFCHECKELEMENTID = $pfcheckelementid$
    AND c.ID = (select  top 1 value from F_Split($singlecodeIds$,',') ) 
    UNION all
    SELECT 
    F.WEIGHDETAILSID AS CHECKPOSITIONDETAILSID
    FROM MES_WEIGHDATA F
    JOIN MES_CHECKDATA A
    ON F.CHECKELEMENTID = A.ID
    LEFT JOIN MES_PROCESSDETAILS B
    ON A.PROCESSDETAILSID = B.ID
    LEFT JOIN MDM_MATERIALINFO C
    ON F.MATERIALID = C.ID
    LEFT JOIN MES_WORKORDERSINGLECODE D
    ON B.WORKORDERSINGLECODEID = D.ID
    WHERE B.WORKORDERID = $workorderid$  AND B.ID = $processdetailsid$  AND A.PFCHECKELEMENTID = $pfcheckelementid$
    AND D.ID = (select  top 1 value from F_Split($singlecodeIds$,',') ) 
    UNION all 
    SELECT 
    F.CHECKLISTDETAILSID AS CHECKPOSITIONDETAILSID
    FROM MES_CHECKLISTDATA F
    LEFT JOIN MES_CHECKDATA A
    ON F.CHECKELEMENTID = A.ID
    LEFT JOIN MES_PROCESSDETAILS B
    ON A.PROCESSDETAILSID = B.ID
    LEFT JOIN MES_WORKORDERSINGLECODE C
    ON B.WORKORDERSINGLECODEID = C.ID
    WHERE B.WORKORDERID = $workorderid$  and B.ID = $processdetailsid$  AND A.PFCHECKELEMENTID = $pfcheckelementid$
    AND c.ID = (select  top 1 value from F_Split($singlecodeIds$,',') ) 
   )AS A




SELECT @RESOURCESBARCODE = B.MEASUREBARCODE FROM
(
SELECT  MAX(MEASUREBARCODE) AS MEASUREBARCODE  FROM MES_CHECKPOSITIONDATA WHERE ID IN
 (SELECT  ID FROM MES_CHECKPOSITIONDATA WHERE CHECKPOSITIONDETAILSID = @CHECKPOSITIONDETAILSID AND CHECKELEMENTID IN
 (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
 (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
 ($singlecodeIds$,',')
 )
 )
 ) 
 )
 )
 UNION ALL
 SELECT  MAX(MEASUREBARCODE) AS MEASUREBARCODE  FROM MES_CHECKLISTDATA WHERE ID IN
 (SELECT  ID FROM MES_CHECKLISTDATA WHERE CHECKLISTDETAILSID = @CHECKPOSITIONDETAILSID AND CHECKELEMENTID IN
 (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
 (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
 ($singlecodeIds$,',')
 )
 )
 ) 
 )
 )
 UNION ALL
 SELECT  MAX(EQUIPMENTBARCODE) AS MEASUREBARCODE  FROM MES_WEIGHDATA WHERE ID IN
 (SELECT  ID FROM MES_WEIGHDATA WHERE WEIGHDETAILSID = @CHECKPOSITIONDETAILSID AND CHECKELEMENTID IN
 (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
 (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
 ($singlecodeIds$,',')
 )
 )
 ) 
 )
 )
 ) AS B

 
DECLARE @tempTable TABLE
(
  ID varchar(2500)
)
INSERT INTO @tempTable
SELECT
  value
FROM
  [dbo].F_Split(@RESOURCESBARCODE,',')


SET @value = $value$

DELETE FROM @tempTable WHERE 
ID = @value



SELECT @RESOURCESBARCODE1 =  STUFF((SELECT ',' +ID FROM  @tempTable FOR XML PATH('')),1,1,'')



 IF(SELECT DISTINCT ELEMENTFLAG FROM MES_CHECKDATA WHERE PFCHECKELEMENTID = $pfcheckelementid$) = 1
	 BEGIN
      UPDATE MES_CHECKPOSITIONDATA
      SET MEASUREBARCODE = @RESOURCESBARCODE1
      WHERE ID IN (SELECT  ID FROM MES_CHECKPOSITIONDATA WHERE CHECKPOSITIONDETAILSID = @CHECKPOSITIONDETAILSID AND CHECKELEMENTID IN
      (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
      (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
      ($singlecodeIds$,',')
      )
      )
      ) 
      )
     )
	 END
	 ELSE IF(SELECT DISTINCT ELEMENTFLAG FROM MES_CHECKDATA WHERE PFCHECKELEMENTID = $pfcheckelementid$) = 2
	 BEGIN
	 UPDATE MES_WEIGHDATA
      SET EQUIPMENTBARCODE = @RESOURCESBARCODE1
      WHERE ID IN (SELECT  ID FROM MES_WEIGHDATA WHERE WEIGHDETAILSID = @CHECKPOSITIONDETAILSID AND CHECKELEMENTID IN
      (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
      (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
      ($singlecodeIds$,',')
      )
      )
      ) 
      )
     )
	 END
	 ELSE IF(SELECT DISTINCT ELEMENTFLAG FROM MES_CHECKDATA WHERE PFCHECKELEMENTID = $pfcheckelementid$) = 3
	 UPDATE MES_CHECKLISTDATA
      SET MEASUREBARCODE = @RESOURCESBARCODE1
      WHERE ID IN (SELECT  ID FROM MES_CHECKLISTDATA WHERE CHECKLISTDETAILSID = @CHECKPOSITIONDETAILSID AND CHECKELEMENTID IN
      (SELECT ID FROM MES_CHECKDATA WHERE PROCESSDETAILSID IN (SELECT ID FROM  MES_PROCESSDETAILS WHERE WORKORDERSINGLECODEID IN 
      (SELECT ID FROM MES_WORKORDERSINGLECODE WHERE ID IN(SELECT VALUE FROM F_Split
      ($singlecodeIds$,',')
      )
      )
      ) 
      )
     )